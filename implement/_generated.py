
import os
import psycopg2
import psycopg2.extras
import tabulate
from dotenv import load_dotenv

# DO NOT EDIT THIS FILE, IT IS GENERATED BY generator.py

def query():
    load_dotenv()

    user = os.getenv('USER')
    password = os.getenv('PASSWORD')
    dbname = os.getenv('DBNAME')

    conn = psycopg2.connect("dbname="+dbname+" user="+user+" password="+password,
                            cursor_factory=psycopg2.extras.DictCursor)
    cur = conn.cursor()
    cur.execute("SELECT * FROM sales")
    
    _global = []
    
    listAggVars = ['cust']
    numGroupVars = 3
    dict = {}
    #dataDict = {} just data for the keys not the final value
    
    for row in cur: #loop to put all keys in dictionary
        #_global.append(row)
        uniqueID = "" # this is gonna be a combination of the agg vars for the dict key
        for aggVar in listAggVars:
            uniqueID = uniqueID + row[aggVar]
        dict[uniqueID] = {}
        for aggVar in range(len(listAggVars)):
            dict[uniqueID][row[aggVar]] = row[aggVar]
        for groupVar in range(numGroupVars):
            for agg in [[('1', 'sum', 'quant'), ('1', 'avg', 'quant')], [('2', 'sum', 'quant')], [('3', 'sum', 'quant'), ('3', 'avg', 'quant')]][groupVar]:
                if agg[1] == "count":
                    dict[uniqueID]["count" + str(groupVar)] = 0
                if agg[1] == "sum":
                    dict[uniqueID]["sum" + str(groupVar)] = 0
                if agg[1] == "max":
                    dict[uniqueID]["max" + str(groupVar)] = 0
                if agg[1] == "min":
                    dict[uniqueID]["min" + str(groupVar)] = 0
                if agg[1] == "avg":
                    dict[uniqueID]["sumAvg" + str(groupVar)] = 0
                    dict[uniqueID]["countAvg" + str(groupVar)] = 0
    cur.execute("SELECT * FROM sales")
    for groupVar in range(numGroupVars): #loop to calculate all the aggregates
        for row in cur:
            uniqueID = "" # this is gonna be a combination of the agg vars for the dict key
            for aggVar in listAggVars:
                uniqueID = uniqueID + row[aggVar]
            for agg in [[('1', 'sum', 'quant'), ('1', 'avg', 'quant')], [('2', 'sum', 'quant')], [('3', 'sum', 'quant'), ('3', 'avg', 'quant')]][groupVar]:
                if agg[1] == "count":
                    dict[uniqueID]["count" + str(groupVar)] += 1
                if agg[1] == "sum":
                    dict[uniqueID]["sum" + str(groupVar)] += row[agg[2]]
                if agg[1] == "max":
                    if(row[agg[2]] > dict[uniqueID]["max" + str(groupVar)]):
                        dict[uniqueID]["max" + str(groupVar)] = row[agg[2]]
                if agg[1] == "min":
                    if(row[agg[2]] < dict[uniqueID]["max" + str(groupVar)]):
                        dict[uniqueID]["max" + str(groupVar)] = row[agg[2]]
                if agg[1] == "avg":
                    dict[uniqueID]["sumAvg" + str(groupVar)] += row[agg[2]]
                    dict[uniqueID]["countAvg" + str(groupVar)] += 1
        cur.execute("SELECT * FROM sales")
        
    for groupVar in range(numGroupVars): #loop to calculate avg and clean up average in dict
        for agg in [[('1', 'sum', 'quant'), ('1', 'avg', 'quant')], [('2', 'sum', 'quant')], [('3', 'sum', 'quant'), ('3', 'avg', 'quant')]][groupVar]:
            for uniqueID in list(dict.keys()):
                if agg[1] == "avg":
                        dict[uniqueID]["avg" + str(groupVar)] =  dict[uniqueID]["sumAvg" + str(groupVar)] / dict[uniqueID]["countAvg" + str(groupVar)]
                        del dict[uniqueID]["sumAvg" + str(groupVar)]
                        del dict[uniqueID]["countAvg" + str(groupVar)]
                
    print(dict.keys())
    
    for x in list(dict.values()):
        _global.append(list(x.values()))
    
    return tabulate.tabulate(_global,
                        headers=['cust', 'sum1', 'sum2', 'sum3', 'avg1', 'avg2'], tablefmt="postgres")

def main():
    print(query())
    #query()
    
if "__main__" == __name__:
    main()
    